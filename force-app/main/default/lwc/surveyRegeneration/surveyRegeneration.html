<template>
	<lightning-card title="Regenerate Survey Links" icon-name="standard:link">
		<!-- Loading Spinner -->
		<template lwc:if={isLoading}>
			<div class="slds-is-relative loading-container">
				<lightning-spinner alternative-text="Processing..." size="medium"></lightning-spinner>
			</div>
		</template>

		<!-- Step 1: Input Form -->
		<template lwc:if={showConfirmation}>
			<template lwc:else>
				<div class="slds-p-around_medium">
					<!-- Introduction -->
					<div class="slds-box slds-theme_default slds-m-bottom_medium">
						<h3 class="slds-text-heading_small slds-m-bottom_small">Regenerate Survey Links</h3>
						<p class="slds-text-body_regular slds-m-bottom_small">
							This tool will regenerate survey links and invitations for the selected records. Use the default Training Request settings or supply custom object and field mappings.
						</p>
						<div class="slds-box slds-theme_warning slds-m-top_small">
							<p class="slds-text-heading_small slds-m-bottom_xx-small">⚠️ Important:</p>
							<ul class="slds-list_dotted">
								<li>All existing survey invitations will be deleted</li>
								<li>New survey links with fresh tokens will be generated</li>
								<li>Previous survey links will no longer work</li>
								<li>Participants will need to use the new links</li>
							</ul>
						</div>
					</div>

					<!-- Input Fields -->
					<div class="slds-grid slds-wrap slds-gutters">
						<div class="slds-col slds-size_1-of-1">
							<lightning-record-picker
								label="Search Records"
								placeholder="Search by name"
								value={recordPickerValue}
								object-api-name={recordPickerObjectApiName}
								onchange={handleRecordPickerChange}
								required></lightning-record-picker>
							<div class="slds-m-top_x-small">
								<lightning-button
									variant="neutral"
									label="Add Record"
									onclick={handleAddRecord}
									disabled={isAddRecordDisabled}></lightning-button>
							</div>
							<p class="slds-text-body_small slds-text-color_weak slds-m-top_xx-small">
								Search for records and add them to the list below. This avoids manual ID entry.
							</p>
							<p class="slds-text-body_small slds-text-color_weak">
								Tip: Launch this page from a list view button to auto-load selected record IDs.
							</p>
						</div>
					</div>

					<div class="slds-m-top_small">
						<template lwc:if={hasSelectedRecords}>
							<lightning-datatable
								key-field="id"
								data={selectedRecords}
								columns={recordColumns}
								onrowaction={handleRowAction}
								hide-checkbox-column></lightning-datatable>
							<div class="slds-m-top_x-small">
								<lightning-button
									variant="destructive-text"
									label="Clear All"
									onclick={handleClearAll}></lightning-button>
							</div>
						</template>
						<template lwc:else>
							<p class="slds-text-body_small slds-text-color_weak">No records selected yet.</p>
						</template>
					</div>

					<!-- Advanced Settings -->
					<div class="slds-m-top_medium slds-box slds-theme_shade">
						<lightning-input
							type="toggle"
							label="Use custom object settings"
							checked={useCustomSettings}
							onchange={handleCustomSettingsToggle}></lightning-input>
						<p class="slds-text-body_small slds-text-color_weak slds-m-top_xx-small">
							Leave this off to use the Training_Request__c defaults. Turn it on to target another object and map its survey fields.
						</p>

						<template lwc:if={useCustomSettings}>
								<div class="slds-grid slds-wrap slds-gutters slds-m-top_small">
									<div class="slds-col slds-size_1-of-1">
										<lightning-input
											label="Related Record Object API Name"
											value={relatedRecordObjectApiName}
											onchange={handleObjectApiNameChange}
											placeholder="e.g., Custom_Object__c"
											required></lightning-input>
									</div>
									<div class="slds-col slds-size_1-of-2">
										<lightning-input
											label="Customer Survey Field API Name (on related record)"
											value={customerSurveyFieldApiName}
											onchange={handleCustomerFieldChange}
											placeholder="e.g., Customer_Survey__c"></lightning-input>
									</div>
									<div class="slds-col slds-size_1-of-2">
										<lightning-input
											label="Trainer Survey Field API Name (on related record)"
											value={trainerSurveyFieldApiName}
											onchange={handleTrainerFieldChange}
											placeholder="e.g., Trainer_Survey__c"></lightning-input>
									</div>
									<div class="slds-col slds-size_1-of-2">
										<lightning-input
											label="Participant Survey Field API Name (on related record)"
											value={participantSurveyFieldApiName}
											onchange={handleParticipantFieldChange}
											placeholder="e.g., Participant_Survey__c"></lightning-input>
									</div>
									<div class="slds-col slds-size_1-of-2">
										<lightning-input
											label="Participant Survey Link Field API Name (on participant record)"
											value={participantSurveyLinkFieldApiName}
											onchange={handleParticipantLinkFieldChange}
											placeholder="e.g., Participant_Survey__c"></lightning-input>
									</div>
									<div class="slds-col slds-size_1-of-2">
										<lightning-input
											label="Participant Object API Name"
											value={participantObjectApiName}
											onchange={handleParticipantObjectChange}
											placeholder="e.g., Participants__c"></lightning-input>
									</div>
									<div class="slds-col slds-size_1-of-2">
										<lightning-input
											label="Participant Lookup Field API Name"
											value={participantLookupFieldApiName}
											onchange={handleParticipantLookupChange}
											placeholder="e.g., Training_Request__c"></lightning-input>
									</div>
									<div class="slds-col slds-size_1-of-2">
										<lightning-input
											label="Participant Name Field API Name"
											value={participantNameFieldApiName}
											onchange={handleParticipantNameChange}
											placeholder="e.g., Participant_Name__c"></lightning-input>
									</div>
									<div class="slds-col slds-size_1-of-2">
										<lightning-input
											label="Participant Email Field API Name"
											value={participantEmailFieldApiName}
											onchange={handleParticipantEmailChange}
											placeholder="e.g., Email__c"></lightning-input>
									</div>
									<div class="slds-col slds-size_1-of-2">
										<lightning-input
											label="Training Type Field API Name (optional)"
											value={trainingTypeFieldApiName}
										onchange={handleTrainingTypeFieldChange}
										placeholder="e.g., Training_Type__c"></lightning-input>
								</div>
							</div>
						</template>
					</div>

					<!-- Survey Type Selection -->
						<div class="slds-m-top_medium">
							<fieldset class="slds-form-element">
								<legend class="slds-form-element__legend slds-form-element__label">Survey Types to Regenerate</legend>
								<div class="slds-form-element__control">
									<lightning-input
										type="checkbox"
										label="Regenerate Participant Survey Links"
										checked={regenerateParticipant}
										onchange={handleParticipantChange}></lightning-input>
									<lightning-input type="checkbox" label="Regenerate Customer Survey Links" checked={regenerateCustomer} onchange={handleCustomerChange}></lightning-input>
									<lightning-input type="checkbox" label="Regenerate Trainer Survey Links" checked={regenerateTrainer} onchange={handleTrainerChange}></lightning-input>
								</div>
							</fieldset>
						</div>

					<!-- When to Use -->
					<div class="slds-box slds-theme_shade slds-m-top_medium">
						<p class="slds-text-heading_small slds-m-bottom_xx-small">When to use:</p>
						<ul class="slds-list_dotted">
							<li>Survey template questions have been updated</li>
							<li>Survey needs to be redistributed with new content</li>
							<li>Links need to be refreshed for security reasons</li>
							<li>Custom objects need refreshed survey invitations</li>
						</ul>
					</div>

					<!-- Actions -->
					<div class="slds-m-top_medium">
						<lightning-button variant="brand" label="Next" onclick={handleNext} disabled={isNextDisabled}></lightning-button>
					</div>
				</div>
			</template>
		</template>

		<!-- Step 2: Confirmation -->
		<template lwc:if={showConfirmation}>
			<div class="slds-p-around_medium">
				<div class="slds-box slds-theme_error">
					<h3 class="slds-text-heading_small slds-m-bottom_small" style="color: #c23934">⚠️ Final Confirmation</h3>
					<p class="slds-text-body_regular slds-m-bottom_small">You are about to regenerate survey links for the selected records.</p>
					<p class="slds-text-heading_small slds-m-bottom_xx-small">This action will:</p>
					<ul class="slds-list_dotted">
						<li>Delete all existing survey invitations</li>
						<li>Generate new survey links with new tokens</li>
						<li>Update related records and participants (when applicable)</li>
						<li>Invalidate all previous survey links</li>
					</ul>
					<p class="slds-text-body_regular slds-m-top_small" style="color: #c23934; font-weight: bold;">This action cannot be undone.</p>
				</div>

				<!-- Actions -->
				<div class="slds-m-top_medium">
					<lightning-button label="Previous" onclick={handleBack} class="slds-m-right_small"></lightning-button>
					<lightning-button variant="destructive" label="Confirm & Regenerate" onclick={handleConfirm} disabled={isLoading}></lightning-button>
				</div>
			</div>
		</template>

		<!-- Step 3: Results -->
		<template lwc:if={showResults}>
			<div class="slds-p-around_medium">
				<!-- Success Message -->
				<template lwc:if={showSuccessMessage}>
					<div class="slds-box slds-theme_success slds-m-bottom_medium">
						<h3 class="slds-text-heading_small slds-m-bottom_small" style="color: #027e46">✓ Survey Links Regenerated Successfully</h3>
						<p class="slds-text-body_regular">The survey links and invitations have been regenerated.</p>
					</div>
				</template>

				<!-- Error Message -->
				<template lwc:if={showErrorMessage}>
					<div class="slds-box slds-theme_error slds-m-bottom_medium">
						<h3 class="slds-text-heading_small slds-m-bottom_small" style="color: #c23934">⚠️ Regeneration Completed with Errors</h3>
						<p class="slds-text-body_regular">Some survey links could not be regenerated.</p>
					</div>
				</template>

				<!-- Summary Statistics -->
				<div class="slds-box slds-theme_default">
					<h3 class="slds-text-heading_small slds-m-bottom_small">Summary</h3>
					<dl class="slds-dl_horizontal">
						<dt class="slds-dl_horizontal__label">Records Processed:</dt>
						<dd class="slds-dl_horizontal__detail">{totalProcessed}</dd>
						<dt class="slds-dl_horizontal__label">Successful:</dt>
						<dd class="slds-dl_horizontal__detail">{totalSuccess}</dd>
						<dt class="slds-dl_horizontal__label">Failed:</dt>
						<dd class="slds-dl_horizontal__detail">{totalFailed}</dd>
						<dt class="slds-dl_horizontal__label">Participant Links Generated:</dt>
						<dd class="slds-dl_horizontal__detail">{participantLinksGenerated}</dd>
						<dt class="slds-dl_horizontal__label">Customer Links Generated:</dt>
						<dd class="slds-dl_horizontal__detail">{customerLinksGenerated}</dd>
						<dt class="slds-dl_horizontal__label">Trainer Links Generated:</dt>
						<dd class="slds-dl_horizontal__detail">{trainerLinksGenerated}</dd>
					</dl>
					<p class="slds-text-body_regular slds-m-top_small">{message}</p>
				</div>

				<!-- Error Details -->
				<template lwc:if={errorDetails}>
					<div class="slds-box slds-theme_shade slds-m-top_medium">
						<h3 class="slds-text-heading_small slds-m-bottom_small">Error Details</h3>
						<p class="slds-text-body_regular">{errorDetails}</p>
					</div>
				</template>

				<!-- Next Steps -->
				<div class="slds-box slds-theme_info slds-m-top_medium">
					<h3 class="slds-text-heading_small slds-m-bottom_small">Next Steps</h3>
						<ul class="slds-list_dotted">
							<li>Review the updated records</li>
							<li>Distribute new survey links to participants (when applicable)</li>
							<li>Previous survey links are no longer valid</li>
						</ul>
				</div>

				<!-- Actions -->
				<div class="slds-m-top_medium">
					<lightning-button variant="brand" label="Regenerate More" onclick={handleReset}></lightning-button>
				</div>
			</div>
		</template>
	</lightning-card>
</template>
