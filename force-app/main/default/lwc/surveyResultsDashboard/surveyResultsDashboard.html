<template>
	<div class="results-dashboard">
		<!-- Loading State -->
		<template lwc:if={isLoading}>
			<div class="slds-is-relative loading-container">
				<lightning-spinner alternative-text="Loading results..." size="medium"></lightning-spinner>
			</div>
		</template>

		<!-- Main Content -->
		<template lwc:else>
			<!-- Header Section -->
			<div class="dashboard-header slds-p-around_medium">
				<div class="slds-grid slds-grid_align-spread slds-gutters slds-m-bottom_medium">
					<div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
						<div class="slds-media slds-media_center">
							<div class="slds-media__figure">
								<lightning-icon icon-name="standard:report" size="large"></lightning-icon>
							</div>
							<div class="slds-media__body">
								<h1 class="slds-text-heading_large">{surveyName}</h1>
								<p class="slds-text-body_small slds-text-color_weak">Survey Results & Analytics</p>
							</div>
						</div>
					</div>
					<div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
						<div class="slds-grid slds-grid_align-end slds-gutters_small">
							<div class="slds-col">
								<lightning-combobox
									name="view"
									label="View"
									value={selectedView}
									options={viewOptions}
									onchange={handleViewChange}
									variant="label-hidden"
									placeholder="Select view"></lightning-combobox>
							</div>
							<div class="slds-col">
								<lightning-button-group>
									<lightning-button label="Refresh" icon-name="utility:refresh" onclick={handleRefresh}></lightning-button>
									<lightning-button label="Export" icon-name="utility:download" onclick={handleExport}></lightning-button>
								</lightning-button-group>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Key Metrics Summary -->
			<div class="metrics-section slds-p-horizontal_medium slds-m-bottom_large">
				<div class="slds-grid slds-wrap slds-gutters">
					<!-- Total Responses -->
					<div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-4">
						<div class="metric-card slds-box slds-theme_default">
							<div class="slds-media">
								<div class="slds-media__figure">
									<lightning-icon icon-name="standard:feedback" size="small" alternative-text="Total Responses"></lightning-icon>
								</div>
								<div class="slds-media__body">
									<p class="slds-text-body_small slds-text-color_weak">Total Responses</p>
									<p class="slds-text-heading_large metric-value">{totalResponses}</p>
								</div>
							</div>
						</div>
					</div>

					<!-- Total Questions -->
					<div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-4">
						<div class="metric-card slds-box slds-theme_default">
							<div class="slds-media">
								<div class="slds-media__figure">
									<lightning-icon icon-name="utility:questions_and_answers" size="small" alternative-text="Questions"></lightning-icon>
								</div>
								<div class="slds-media__body">
									<p class="slds-text-body_small slds-text-color_weak">Questions</p>
									<p class="slds-text-heading_large metric-value">{totalQuestions}</p>
								</div>
							</div>
						</div>
					</div>

					<!-- Completion Rate -->
					<div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-4">
						<div class="metric-card slds-box slds-theme_default">
							<div class="slds-media">
								<div class="slds-media__figure">
									<lightning-icon icon-name="utility:success" size="small" alternative-text="Completion Rate"></lightning-icon>
								</div>
								<div class="slds-media__body">
									<p class="slds-text-body_small slds-text-color_weak">Completion Rate</p>
									<p class="slds-text-heading_large metric-value">{completionRate}</p>
								</div>
							</div>
						</div>
					</div>

					<!-- Avg Time -->
					<div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-4">
						<div class="metric-card slds-box slds-theme_default">
							<div class="slds-media">
								<div class="slds-media__figure">
									<lightning-icon icon-name="utility:clock" size="small" alternative-text="Avg Time"></lightning-icon>
								</div>
								<div class="slds-media__body">
									<p class="slds-text-body_small slds-text-color_weak">Avg Time</p>
									<p class="slds-text-heading_large metric-value">{averageTimeToComplete}</p>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Overview View -->
			<template lwc:if={isOverviewView}>
				<div class="content-section slds-p-horizontal_medium">
					<div class="slds-grid slds-wrap slds-gutters">
						<!-- Response Timeline -->
						<div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2">
							<div class="slds-card">
								<div class="slds-card__header slds-grid">
									<header class="slds-media slds-media_center slds-has-flexi-truncate">
										<div class="slds-media__figure">
											<lightning-icon icon-name="utility:chart" size="small"></lightning-icon>
										</div>
										<div class="slds-media__body">
											<h2 class="slds-card__header-title">Response Timeline (Last 7 Days)</h2>
										</div>
									</header>
								</div>
								<div class="slds-card__body slds-card__body_inner">
									<template lwc:if={responsesByDate}>
										<template for:each={responsesByDate} for:item="dataPoint">
											<div key={dataPoint.date} class="timeline-item slds-p-vertical_small">
												<div class="slds-grid slds-grid_vertical-align-center">
													<div class="slds-col slds-size_1-of-3">
														<span class="slds-text-body_small">{dataPoint.date}</span>
													</div>
													<div class="slds-col slds-size_2-of-3">
														<div class="response-bar" style={dataPoint.barStyle}>
															<span class="response-count">{dataPoint.count}</span>
														</div>
													</div>
												</div>
											</div>
										</template>
									</template>
									<template lwc:else>
										<div class="slds-text-align_center slds-p-vertical_large">
											<p class="slds-text-body_small slds-text-color_weak">No response data available</p>
										</div>
									</template>
								</div>
							</div>
						</div>

						<!-- Response Summary -->
						<div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2">
							<div class="slds-card">
								<div class="slds-card__header slds-grid">
									<header class="slds-media slds-media_center slds-has-flexi-truncate">
										<div class="slds-media__figure">
											<lightning-icon icon-name="utility:summary" size="small"></lightning-icon>
										</div>
										<div class="slds-media__body">
											<h2 class="slds-card__header-title">Response Summary</h2>
										</div>
									</header>
								</div>
								<div class="slds-card__body slds-card__body_inner">
									<template lwc:if={hasResponses}>
										<div class="slds-text-align_center slds-p-around_large">
											<lightning-icon icon-name="utility:comments" size="large" class="slds-m-bottom_medium"></lightning-icon>
											<p class="slds-text-heading_medium slds-m-bottom_small">{totalResponses} Total Responses</p>
											<p class="slds-text-body_regular slds-text-color_weak">View detailed analytics by switching views above</p>
										</div>
									</template>
									<template lwc:else>
										<div class="slds-illustration slds-illustration_small slds-p-around_large slds-text-align_center">
											<div class="slds-text-longform">
												<h3 class="slds-text-heading_medium">No Responses Yet</h3>
												<p class="slds-text-body_regular">Responses will appear here once your survey is completed by participants.</p>
											</div>
										</div>
									</template>
								</div>
							</div>
						</div>
					</div>
				</div>
			</template>

			<!-- Individual Responses View -->
			<template lwc:if={isResponsesView}>
				<div class="content-section slds-p-horizontal_medium">
					<div class="slds-card">
						<div class="slds-card__header slds-grid">
							<header class="slds-media slds-media_center slds-has-flexi-truncate">
								<div class="slds-media__figure">
									<lightning-icon icon-name="utility:list" size="small"></lightning-icon>
								</div>
								<div class="slds-media__body">
									<h2 class="slds-card__header-title">Individual Responses</h2>
								</div>
							</header>
						</div>
						<div class="slds-card__body slds-card__body_inner">
							<template lwc:if={hasResponses}>
								<div class="slds-text-align_center slds-p-around_xx-large">
									<lightning-icon icon-name="standard:record" size="large" class="slds-m-bottom_medium"></lightning-icon>
									<p class="slds-text-heading_medium slds-m-bottom_small">Individual Response Viewer</p>
									<p class="slds-text-body_regular slds-text-color_weak slds-m-bottom_medium">View individual survey responses with detailed breakdown of answers</p>
									<p class="slds-text-body_small slds-text-color_weak">Navigate to Survey Taker records to view individual responses</p>
								</div>
							</template>
							<template lwc:else>
								<div class="slds-illustration slds-illustration_small slds-p-around_large slds-text-align_center">
									<div class="slds-text-longform">
										<h3 class="slds-text-heading_medium">No Responses to Display</h3>
										<p class="slds-text-body_regular">Individual responses will appear here once survey submissions are received.</p>
									</div>
								</div>
							</template>
						</div>
					</div>
				</div>
			</template>

			<!-- Question Analysis View -->
			<template lwc:if={isQuestionsView}>
				<div class="content-section slds-p-horizontal_medium">
					<div class="slds-card">
						<div class="slds-card__header slds-grid">
							<header class="slds-media slds-media_center slds-has-flexi-truncate">
								<div class="slds-media__figure">
									<lightning-icon icon-name="utility:analytics" size="small"></lightning-icon>
								</div>
								<div class="slds-media__body">
									<h2 class="slds-card__header-title">Question-by-Question Analysis</h2>
								</div>
							</header>
						</div>
						<div class="slds-card__body slds-card__body_inner">
							<div class="slds-text-align_center slds-p-around_xx-large">
								<lightning-icon icon-name="utility:chart" size="large" class="slds-m-bottom_medium"></lightning-icon>
								<p class="slds-text-heading_medium slds-m-bottom_small">Detailed Question Analytics</p>
								<p class="slds-text-body_regular slds-text-color_weak slds-m-bottom_medium">Analyze response patterns for each question with charts and statistics</p>
								<p class="slds-text-body_small slds-text-color_weak">Use the Survey with Questions and Responses report for detailed analysis</p>
							</div>
						</div>
					</div>
				</div>
			</template>
		</template>
	</div>
</template>
