<template>
	<div class="analytics-dashboard">
		<!-- Loading State -->
		<template lwc:if={isLoading}>
			<div class="slds-is-relative loading-container">
				<lightning-spinner alternative-text="Loading analytics..." size="medium"></lightning-spinner>
			</div>
		</template>

		<!-- Main Dashboard Content -->
		<template lwc:else>
			<!-- Header Section with Search and Filters -->
			<div class="dashboard-header slds-p-around_medium">
				<div class="slds-grid slds-grid_align-spread slds-gutters slds-m-bottom_medium">
					<div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
						<div class="slds-media slds-media_center">
							<div class="slds-media__figure">
								<lightning-icon icon-name="standard:metrics" size="large"></lightning-icon>
							</div>
							<div class="slds-media__body">
								<h1 class="slds-text-heading_large">Survey Analytics</h1>
								<p class="slds-text-body_small slds-text-color_weak">Comprehensive overview of your survey performance</p>
							</div>
						</div>
					</div>
					<div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
						<div class="slds-grid slds-grid_align-end slds-gutters_small">
							<div class="slds-col">
								<lightning-combobox
									name="timeframe"
									label="Timeframe"
									value={selectedTimeframe}
									options={timeframeOptions}
									onchange={handleTimeframeChange}
									variant="label-hidden"
									placeholder="Select timeframe"></lightning-combobox>
							</div>
							<div class="slds-col">
								<lightning-button-group>
									<lightning-button label="Refresh" icon-name="utility:refresh" onclick={handleRefresh}></lightning-button>
									<lightning-button variant="brand" label="New Survey" icon-name="utility:add" onclick={handleCreateSurvey}></lightning-button>
								</lightning-button-group>
							</div>
						</div>
					</div>
				</div>

				<!-- Search Bar -->
				<div class="slds-grid slds-gutters">
					<div class="slds-col slds-size_1-of-1">
						<lightning-input
							type="search"
							label="Search Surveys"
							value={searchTerm}
							onchange={handleSearchChange}
							placeholder="Search by survey name..."
							variant="label-hidden"
							class="search-input"></lightning-input>
					</div>
				</div>
			</div>

			<!-- Key Metrics Cards -->
			<template lwc:if={hasSurveys}>
				<div class="metrics-section slds-p-horizontal_medium slds-m-bottom_large">
					<div class="slds-grid slds-wrap slds-gutters">
						<!-- Total Surveys -->
						<div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-3 slds-large-size_1-of-6">
							<div class="metric-card slds-box slds-theme_default">
								<div class="slds-media slds-media_center">
									<div class="slds-media__figure">
										<lightning-icon icon-name="custom:custom63" size="small" alternative-text="Total Surveys"></lightning-icon>
									</div>
									<div class="slds-media__body">
										<p class="slds-text-body_small slds-text-color_weak">Total Surveys</p>
										<p class="slds-text-heading_large metric-value">{totalSurveys}</p>
									</div>
								</div>
							</div>
						</div>

						<!-- Total Responses -->
						<div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-3 slds-large-size_1-of-6">
							<div class="metric-card slds-box slds-theme_default">
								<div class="slds-media slds-media_center">
									<div class="slds-media__figure">
										<lightning-icon icon-name="standard:feedback" size="small" alternative-text="Total Responses"></lightning-icon>
									</div>
									<div class="slds-media__body">
										<p class="slds-text-body_small slds-text-color_weak">Total Responses</p>
										<p class="slds-text-heading_large metric-value">{totalResponses}</p>
									</div>
								</div>
							</div>
						</div>

						<!-- Total Questions -->
						<div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-3 slds-large-size_1-of-6">
							<div class="metric-card slds-box slds-theme_default">
								<div class="slds-media slds-media_center">
									<div class="slds-media__figure">
										<lightning-icon icon-name="utility:questions_and_answers" size="small" alternative-text="Total Questions"></lightning-icon>
									</div>
									<div class="slds-media__body">
										<p class="slds-text-body_small slds-text-color_weak">Total Questions</p>
										<p class="slds-text-heading_large metric-value">{totalQuestions}</p>
									</div>
								</div>
							</div>
						</div>

						<!-- Average Responses -->
						<div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-3 slds-large-size_1-of-6">
							<div class="metric-card slds-box slds-theme_default">
								<div class="slds-media slds-media_center">
									<div class="slds-media__figure">
										<lightning-icon icon-name="utility:trending" size="small" alternative-text="Avg Responses"></lightning-icon>
									</div>
									<div class="slds-media__body">
										<p class="slds-text-body_small slds-text-color_weak">Avg Responses</p>
										<p class="slds-text-heading_large metric-value">{averageResponsesPerSurvey}</p>
									</div>
								</div>
							</div>
						</div>

						<!-- Active Surveys -->
						<div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-3 slds-large-size_1-of-6">
							<div class="metric-card slds-box slds-theme_default">
								<div class="slds-media slds-media_center">
									<div class="slds-media__figure">
										<lightning-icon icon-name="utility:success" size="small" alternative-text="Active Surveys"></lightning-icon>
									</div>
									<div class="slds-media__body">
										<p class="slds-text-body_small slds-text-color_weak">Active Surveys</p>
										<p class="slds-text-heading_large metric-value">{activeSurveys}</p>
									</div>
								</div>
							</div>
						</div>

						<!-- Public Surveys -->
						<div class="slds-col slds-size_1-of-2 slds-medium-size_1-of-3 slds-large-size_1-of-6">
							<div class="metric-card slds-box slds-theme_default">
								<div class="slds-media slds-media_center">
									<div class="slds-media__figure">
										<lightning-icon icon-name="utility:record_update" size="small" alternative-text="Active Surveys"></lightning-icon>
									</div>
									<div class="slds-media__body">
										<p class="slds-text-body_small slds-text-color_weak">Active Surveys</p>
										<p class="slds-text-heading_large metric-value">{activeSurveys}</p>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Dashboard Content Grid -->
				<template lwc:if={hasFilteredResults}>
					<div class="dashboard-content slds-p-horizontal_medium">
						<div class="slds-grid slds-wrap slds-gutters">
							<!-- Top Performing Surveys -->
							<div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2">
								<div class="slds-card">
									<div class="slds-card__header slds-grid">
										<header class="slds-media slds-media_center slds-has-flexi-truncate">
											<div class="slds-media__figure">
												<lightning-icon icon-name="utility:chart" size="small"></lightning-icon>
											</div>
											<div class="slds-media__body">
												<h2 class="slds-card__header-title">Top Performing Surveys</h2>
											</div>
										</header>
									</div>
									<div class="slds-card__body slds-card__body_inner">
										<template for:each={topPerformingSurveys} for:item="survey">
											<div key={survey.Id} class="survey-item slds-box slds-theme_shade slds-m-bottom_small">
												<div class="slds-grid slds-grid_vertical-align-center">
													<div class="slds-col slds-grow">
														<div
															class="survey-name slds-text-body_regular slds-text-color_default slds-truncate slds-m-bottom_xx-small"
															data-survey-id={survey.Id}
															onclick={handleViewSurvey}
															style="cursor: pointer">
															{survey.Name}
														</div>
														<div class="slds-text-body_small slds-text-color_weak">{survey.Completed_Surveys__c} responses â€¢ {survey.Questions__c} questions</div>
													</div>
													<div class="slds-col slds-no-flex">
														<span class="slds-badge slds-theme_success">{survey.responsePercentage}%</span>
													</div>
												</div>
											</div>
										</template>
									</div>
									<div class="slds-card__footer">
										<lightning-button label="View All Surveys" onclick={handleViewAllSurveys} class="slds-button_stretch"></lightning-button>
									</div>
								</div>
							</div>

							<!-- Recent Surveys -->
							<div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2">
								<div class="slds-card">
									<div class="slds-card__header slds-grid">
										<header class="slds-media slds-media_center slds-has-flexi-truncate">
											<div class="slds-media__figure">
												<lightning-icon icon-name="utility:clock" size="small"></lightning-icon>
											</div>
											<div class="slds-media__body">
												<h2 class="slds-card__header-title">Recently Created</h2>
											</div>
										</header>
									</div>
									<div class="slds-card__body slds-card__body_inner">
										<template for:each={recentSurveys} for:item="survey">
											<div key={survey.Id} class="survey-item slds-box slds-theme_shade slds-m-bottom_small">
												<div class="slds-grid slds-grid_vertical-align-center">
													<div class="slds-col slds-grow">
														<div
															class="survey-name slds-text-body_regular slds-text-color_default slds-truncate slds-m-bottom_xx-small"
															data-survey-id={survey.Id}
															onclick={handleViewSurvey}
															style="cursor: pointer">
															{survey.Name}
														</div>
														<div class="slds-text-body_small slds-text-color_weak">
															<lightning-formatted-date-time value={survey.CreatedDate} day="numeric" month="short" year="numeric"></lightning-formatted-date-time>
														</div>
													</div>
													<div class="slds-col slds-no-flex">
														<!-- All surveys now use token-based access -->
													</div>
												</div>
											</div>
										</template>
									</div>
									<div class="slds-card__footer">
										<lightning-button label="Create New Survey" variant="brand" onclick={handleCreateSurvey} class="slds-button_stretch"></lightning-button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</template>

				<!-- No Results State -->
				<template lwc:else>
					<div class="slds-illustration slds-illustration_small slds-p-around_xx-large slds-text-align_center">
						<div class="slds-text-longform">
							<h3 class="slds-text-heading_medium">No surveys match your filters</h3>
							<p class="slds-text-body_regular">Try adjusting your search or timeframe</p>
						</div>
					</div>
				</template>
			</template>

			<!-- Empty State -->
			<template lwc:else>
				<div class="empty-state slds-illustration slds-illustration_large slds-p-around_xx-large slds-text-align_center">
					<lightning-icon icon-name="standard:survey" size="large" class="slds-m-bottom_large"></lightning-icon>
					<div class="slds-text-longform">
						<h3 class="slds-text-heading_large slds-m-bottom_medium">Welcome to Survey Force</h3>
						<p class="slds-text-body_regular slds-m-bottom_large">Get started by creating your first survey to collect valuable feedback and insights.</p>
						<lightning-button variant="brand" label="Create Your First Survey" icon-name="utility:add" onclick={handleCreateSurvey}></lightning-button>
					</div>
				</div>
			</template>
		</template>
	</div>
</template>
