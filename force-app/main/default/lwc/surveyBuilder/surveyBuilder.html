<template>
	<lightning-card title="Survey Builder" icon-name="standard:survey">
		<!-- Loading State -->
		<template if:true={isLoading}>
			<div class="slds-is-relative" style="min-height: 300px">
				<lightning-spinner alternative-text="Loading survey..." size="medium"></lightning-spinner>
			</div>
		</template>

		<!-- Error State -->
		<template if:true={error}>
			<div class="slds-box slds-theme_error slds-m-around_medium">
				<p class="slds-text-heading_small">{error}</p>
			</div>
		</template>

		<!-- Main Content -->
		<template if:false={isLoading}>
			<template if:false={error}>
				<!-- Header Actions -->
				<div slot="actions">
					<lightning-button-group>
						<lightning-button label="Settings" icon-name="utility:settings" onclick={handleOpenSettings}></lightning-button>
						<lightning-button label="Preview" icon-name="utility:preview" onclick={handlePreviewSurvey}></lightning-button>
						<lightning-button variant="brand" label="Add Question" icon-name="utility:add" onclick={handleAddQuestion}></lightning-button>
					</lightning-button-group>
				</div>

				<div class="slds-m-around_medium">
					<!-- Survey Info Header -->
					<div class="slds-box slds-theme_shade slds-m-bottom_medium">
						<div class="slds-grid slds-wrap">
							<div class="slds-col slds-size_1-of-1 slds-medium-size_2-of-3">
								<h2 class="slds-text-heading_medium slds-m-bottom_x-small">{survey.Name}</h2>
								<template if:true={survey.Survey_Header__c}>
									<p class="slds-text-body_regular slds-text-color_weak">{survey.Survey_Header__c}</p>
								</template>
							</div>
							<div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-text-align_right">
								<p class="slds-text-body_small">
									<strong>Questions:</strong>
									{questions.length}
								</p>
							</div>
						</div>
					</div>

					<!-- Questions List -->
					<template if:true={hasQuestions}>
						<div class="slds-box slds-theme_default">
							<h3 class="slds-text-heading_small slds-m-bottom_medium">Questions</h3>

							<template for:each={questions} for:item="question">
								<div key={question.Id} class="slds-box slds-box_x-small slds-theme_shade slds-m-bottom_small">
									<div class="slds-grid slds-wrap slds-grid_vertical-align-center">
										<!-- Question Content -->
										<div class="slds-col slds-size_1-of-1 slds-medium-size_7-of-12">
											<div class="slds-grid slds-grid_vertical-align-center">
												<span class="slds-badge slds-badge_lightest slds-m-right_small">{question.displayOrder}</span>
												<div>
													<p class="slds-text-body_regular slds-m-bottom_xx-small">
														<strong>{question.Question__c}</strong>
														<template if:true={question.Required__c}>
															<abbr class="slds-required slds-m-left_xx-small" title="required">*</abbr>
														</template>
													</p>
													<p class="slds-text-body_small slds-text-color_weak">
														Type: {question.typeLabel}
														<template if:true={question.choicesPreview}>
															<span class="slds-m-left_small">â€¢ Choices: {question.choicesPreview}</span>
														</template>
													</p>
												</div>
											</div>
										</div>

										<!-- Question Actions -->
										<div class="slds-col slds-size_1-of-1 slds-medium-size_5-of-12 slds-text-align_right slds-m-top_small slds-medium-m-top_none">
											<lightning-button-group>
												<lightning-button-icon
													icon-name="utility:arrowup"
													alternative-text="Move Up"
													title="Move Up"
													data-question-id={question.Id}
													onclick={handleMoveUp}></lightning-button-icon>
												<lightning-button-icon
													icon-name="utility:arrowdown"
													alternative-text="Move Down"
													title="Move Down"
													data-question-id={question.Id}
													onclick={handleMoveDown}></lightning-button-icon>
												<lightning-button-icon
													icon-name="utility:edit"
													alternative-text="Edit"
													title="Edit Question"
													data-question-id={question.Id}
													onclick={handleEditQuestion}></lightning-button-icon>
												<lightning-button-icon
													icon-name="utility:delete"
													alternative-text="Delete"
													title="Delete Question"
													variant="destructive"
													data-question-id={question.Id}
													onclick={handleDeleteQuestion}></lightning-button-icon>
											</lightning-button-group>
										</div>
									</div>
								</div>
							</template>
						</div>
					</template>

					<!-- Empty State -->
					<template if:false={hasQuestions}>
						<div class="slds-box slds-theme_default slds-text-align_center slds-p-vertical_large">
							<lightning-icon icon-name="utility:question" size="large" class="slds-m-bottom_medium"></lightning-icon>
							<h3 class="slds-text-heading_medium slds-m-bottom_small">No Questions Yet</h3>
							<p class="slds-text-body_regular slds-text-color_weak slds-m-bottom_medium">Add your first question to start building your survey.</p>
							<lightning-button variant="brand" label="Add First Question" icon-name="utility:add" onclick={handleAddQuestion}></lightning-button>
						</div>
					</template>
				</div>
			</template>
		</template>
	</lightning-card>

	<!-- Question Modal -->
	<template if:true={showQuestionModal}>
		<section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open" aria-modal="true">
			<div class="slds-modal__container">
				<header class="slds-modal__header">
					<lightning-button-icon
						icon-name="utility:close"
						alternative-text="Close"
						onclick={handleCloseQuestionModal}
						class="slds-modal__close"
						variant="bare-inverse"></lightning-button-icon>
					<h2 class="slds-text-heading_medium">{questionModalTitle}</h2>
				</header>
				<div class="slds-modal__content slds-p-around_medium">
					<div class="slds-form">
						<lightning-textarea
							label="Question Text"
							value={questionText}
							onchange={handleQuestionTextChange}
							required
							max-length="32000"
							class="slds-m-bottom_medium"></lightning-textarea>

						<lightning-combobox
							label="Question Type"
							value={questionType}
							options={questionTypeOptions}
							onchange={handleQuestionTypeChange}
							class="slds-m-bottom_medium"></lightning-combobox>

						<template if:true={showChoicesField}>
							<lightning-textarea
								label="Choices (one per line)"
								value={questionChoices}
								onchange={handleQuestionChoicesChange}
								placeholder="Enter each choice on a new line"
								class="slds-m-bottom_medium"></lightning-textarea>
						</template>

						<lightning-input type="number" label="Order Number" value={questionOrder} min="1" onchange={handleQuestionOrderChange} class="slds-m-bottom_medium"></lightning-input>

						<lightning-input type="checkbox" label="Required" checked={questionRequired} onchange={handleQuestionRequiredChange}></lightning-input>
					</div>
				</div>
				<footer class="slds-modal__footer">
					<lightning-button label="Cancel" onclick={handleCloseQuestionModal}></lightning-button>
					<lightning-button variant="brand" label={saveButtonLabel} onclick={handleSaveQuestion} disabled={isSaving}></lightning-button>
				</footer>
			</div>
		</section>
		<div class="slds-backdrop slds-backdrop_open"></div>
	</template>

	<!-- Settings Modal -->
	<template if:true={showSettingsModal}>
		<section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_medium" aria-modal="true">
			<div class="slds-modal__container">
				<header class="slds-modal__header">
					<lightning-button-icon
						icon-name="utility:close"
						alternative-text="Close"
						onclick={handleCloseSettingsModal}
						class="slds-modal__close"
						variant="bare-inverse"></lightning-button-icon>
					<h2 class="slds-text-heading_medium">Survey Settings</h2>
				</header>
				<div class="slds-modal__content slds-p-around_medium">
					<div class="slds-form">
						<lightning-input label="Survey Name" value={surveyName} onchange={handleSurveyNameChange} required class="slds-m-bottom_medium"></lightning-input>

						<lightning-input label="Survey Header" value={surveyHeader} onchange={handleSurveyHeaderChange} class="slds-m-bottom_medium"></lightning-input>

						<lightning-textarea
							label="Thank You Text"
							value={thankYouText}
							onchange={handleThankYouTextChange}
							placeholder="Message displayed after survey submission"
							class="slds-m-bottom_medium"></lightning-textarea>

						<lightning-input
							label="Thank You Link (URL)"
							type="url"
							value={thankYouLink}
							onchange={handleThankYouLinkChange}
							placeholder="https://..."
							class="slds-m-bottom_medium"></lightning-input>

						<div class="slds-form-element slds-m-bottom_medium">
							<lightning-input type="checkbox" label="Hide Survey Name" checked={hideSurveyName} onchange={handleHideSurveyNameChange}></lightning-input>
						</div>

						<div class="slds-form-element slds-m-bottom_medium">
							<lightning-input type="checkbox" label="All Responses Anonymous" checked={allResponsesAnonymous} onchange={handleAllResponsesAnonymousChange}></lightning-input>
							<div class="slds-form-element__help">When enabled, all responses will be anonymous</div>
						</div>

						<div class="slds-form-element">
							<lightning-input type="checkbox" label="Share with Guest Users" checked={shareWithGuestUser} onchange={handleShareWithGuestUserChange}></lightning-input>
							<div class="slds-form-element__help">Allow guest users to access this survey via direct link</div>
						</div>
					</div>
				</div>
				<footer class="slds-modal__footer">
					<lightning-button label="Cancel" onclick={handleCloseSettingsModal}></lightning-button>
					<lightning-button variant="brand" label="Save Settings" onclick={handleSaveSettings} disabled={isSaving}></lightning-button>
				</footer>
			</div>
		</section>
		<div class="slds-backdrop slds-backdrop_open"></div>
	</template>
</template>
