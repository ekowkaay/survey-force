<template>
	<lightning-card title="Survey Invitations" icon-name="standard:email">
		<!-- Loading State -->
		<template lwc:if={isLoading}>
			<div class="slds-is-relative" style="min-height: 200px">
				<lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
			</div>
		</template>

		<!-- Error State -->
		<template lwc:if={error}>
			<div class="slds-box slds-theme_error slds-m-around_medium">
				<p class="slds-text-heading_small">{error}</p>
			</div>
		</template>

		<!-- Main Content -->
		<template lwc:if={showContent}>
			<!-- Header Actions -->
			<div slot="actions">
				<lightning-button-group>
					<lightning-button label="Refresh" icon-name="utility:refresh" onclick={handleRefresh}></lightning-button>
					<lightning-button variant="brand" label="Generate Links" icon-name="utility:add" onclick={handleOpenGenerateModal}></lightning-button>
				</lightning-button-group>
			</div>

			<div class="slds-m-around_medium">
				<!-- Stats -->
				<div class="slds-grid slds-wrap slds-gutters slds-m-bottom_medium">
					<div class="slds-col slds-size_1-of-3">
						<div class="slds-box slds-theme_shade slds-text-align_center">
							<p class="slds-text-heading_large">{totalInvitations}</p>
							<p class="slds-text-body_small slds-text-color_weak">Total Invitations</p>
						</div>
					</div>
					<div class="slds-col slds-size_1-of-3">
						<div class="slds-box slds-theme_shade slds-text-align_center">
							<p class="slds-text-heading_large">{pendingCount}</p>
							<p class="slds-text-body_small slds-text-color_weak">Pending</p>
						</div>
					</div>
					<div class="slds-col slds-size_1-of-3">
						<div class="slds-box slds-theme_shade slds-text-align_center">
							<p class="slds-text-heading_large">{completedCount}</p>
							<p class="slds-text-body_small slds-text-color_weak">Completed</p>
						</div>
					</div>
				</div>

				<!-- Invitations Table -->
				<template lwc:if={hasInvitations}>
					<lightning-datatable key-field="id" data={invitations} columns={columns} hide-checkbox-column onrowaction={handleRowAction}></lightning-datatable>
				</template>

				<!-- Empty State -->
				<template lwc:else>
					<div class="slds-box slds-theme_default slds-text-align_center slds-p-vertical_large">
						<lightning-icon icon-name="utility:email" size="large" class="slds-m-bottom_medium"></lightning-icon>
						<h3 class="slds-text-heading_medium slds-m-bottom_small">No Invitations Yet</h3>
						<p class="slds-text-body_regular slds-text-color_weak slds-m-bottom_medium">Generate unique survey links to share with participants.</p>
						<lightning-button variant="brand" label="Generate Links" icon-name="utility:add" onclick={handleOpenGenerateModal}></lightning-button>
					</div>
				</template>
			</div>
		</template>
	</lightning-card>

	<!-- Generate Links Modal -->
	<template lwc:if={showGenerateModal}>
		<section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open" aria-modal="true">
			<div class="slds-modal__container">
				<header class="slds-modal__header">
					<lightning-button-icon
						icon-name="utility:close"
						alternative-text="Close"
						onclick={handleCloseGenerateModal}
						class="slds-modal__close"
						variant="bare-inverse"></lightning-button-icon>
					<h2 class="slds-text-heading_medium">Generate Survey Links</h2>
				</header>
				<div class="slds-modal__content slds-p-around_medium">
					<lightning-input
						type="number"
						label="Number of Links to Generate"
						value={linkCount}
						onchange={handleLinkCountChange}
						min="1"
						max="200"
						required
						message-when-range-underflow="Must generate at least 1 link"
						message-when-range-overflow="Cannot generate more than 200 links at once"></lightning-input>
					<p class="slds-text-body_small slds-text-color_weak slds-m-top_small">Each link is unique and can only be used once to complete the survey.</p>
				</div>
				<footer class="slds-modal__footer">
					<lightning-button label="Cancel" onclick={handleCloseGenerateModal}></lightning-button>
					<lightning-button variant="brand" label="Generate" onclick={handleGenerateLinks} disabled={isGenerating}></lightning-button>
				</footer>
			</div>
		</section>
		<div class="slds-backdrop slds-backdrop_open"></div>
	</template>

	<!-- Generated Links Modal -->
	<template lwc:if={showLinksModal}>
		<section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_large" aria-modal="true">
			<div class="slds-modal__container">
				<header class="slds-modal__header">
					<lightning-button-icon
						icon-name="utility:close"
						alternative-text="Close"
						onclick={handleCloseLinksModal}
						class="slds-modal__close"
						variant="bare-inverse"></lightning-button-icon>
					<h2 class="slds-text-heading_medium">Generated Survey Links</h2>
				</header>
				<div class="slds-modal__content slds-p-around_medium">
					<p class="slds-m-bottom_medium">{generatedCount} links generated successfully. Copy the links below to share with participants.</p>
					<div class="slds-box slds-theme_shade" style="max-height: 300px; overflow-y: auto">
						<template for:each={generatedLinks} for:item="link">
							<div key={link.token} class="slds-grid slds-grid_vertical-align-center slds-p-vertical_x-small slds-border_bottom">
								<div class="slds-col slds-grow">
									<p class="slds-text-body_small slds-truncate" title={link.surveyUrl}>{link.surveyUrl}</p>
								</div>
								<div class="slds-col slds-no-flex">
									<lightning-button-icon
										icon-name="utility:copy"
										alternative-text="Copy link"
										title="Copy link"
										data-url={link.surveyUrl}
										onclick={handleCopyLink}></lightning-button-icon>
								</div>
							</div>
						</template>
					</div>
				</div>
				<footer class="slds-modal__footer">
					<lightning-button label="Copy All Links" icon-name="utility:copy" onclick={handleCopyAllLinks}></lightning-button>
					<lightning-button variant="brand" label="Done" onclick={handleCloseLinksModal}></lightning-button>
				</footer>
			</div>
		</section>
		<div class="slds-backdrop slds-backdrop_open"></div>
	</template>
</template>
