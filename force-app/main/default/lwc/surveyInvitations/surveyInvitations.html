<template>
	<div class="invitations-container">
		<lightning-card title="Survey Invitations & Link Generator" icon-name="standard:email">
			<!-- Survey Selector (when not on a record page) -->
			<template lwc:if={showSurveySelector}>
				<div class="slds-m-around_medium">
					<lightning-record-picker
						label="Select Survey"
						placeholder="Search for a survey..."
						object-api-name="Survey__c"
						value={selectedSurveyId}
						onchange={handleSurveyChange}></lightning-record-picker>
					<p class="slds-text-body_small slds-text-color_weak slds-m-top_xx-small">
						<lightning-icon icon-name="utility:info" size="xx-small" class="slds-m-right_xx-small"></lightning-icon>
						Choose a survey to view existing invitations or generate new unique links.
					</p>
				</div>
			</template>

			<!-- Loading State -->
			<template lwc:if={isLoading}>
				<div class="slds-is-relative loading-container">
					<lightning-spinner alternative-text="Loading invitations..." size="medium"></lightning-spinner>
					<p class="slds-text-align_center slds-m-top_medium slds-text-body_small slds-text-color_weak">Loading invitations...</p>
				</div>
			</template>

			<!-- Error State -->
			<template lwc:if={error}>
				<div class="slds-box slds-theme_error slds-m-around_medium">
					<p class="slds-text-heading_small">{error}</p>
				</div>
			</template>

			<!-- Main Content -->
			<template lwc:if={showContent}>
				<!-- Header Actions -->
				<div slot="actions">
					<lightning-button-group>
						<lightning-button label="Refresh" icon-name="utility:refresh" onclick={handleRefresh}></lightning-button>
						<lightning-button variant="brand" label="Generate Links" icon-name="utility:add" onclick={handleOpenGenerateModal}></lightning-button>
					</lightning-button-group>
				</div>

				<div class="slds-m-around_medium">
					<!-- Enhanced Stats with Icons -->
					<div class="slds-grid slds-wrap slds-gutters slds-m-bottom_medium">
						<div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
							<div class="stat-card slds-box slds-theme_default slds-text-align_center slds-p-around_medium">
								<div class="slds-media slds-media_center">
									<div class="slds-media__figure">
										<lightning-icon icon-name="standard:link" size="small" alternative-text="Total Invitations"></lightning-icon>
									</div>
									<div class="slds-media__body">
										<p class="slds-text-heading_large" style="color: var(--slds-g-color-brand-base-60, #0176d3)">{totalInvitations}</p>
										<p class="slds-text-body_small slds-text-color_weak">Total Invitations</p>
									</div>
								</div>
							</div>
						</div>
						<div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
							<div class="stat-card slds-box slds-theme_default slds-text-align_center slds-p-around_medium">
								<div class="slds-media slds-media_center">
									<div class="slds-media__figure">
										<lightning-icon icon-name="utility:clock" size="small" alternative-text="Pending"></lightning-icon>
									</div>
									<div class="slds-media__body">
										<p class="slds-text-heading_large" style="color: var(--slds-g-color-palette-orange-65, #fe9339)">{pendingCount}</p>
										<p class="slds-text-body_small slds-text-color_weak">Pending</p>
									</div>
								</div>
							</div>
						</div>
						<div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
							<div class="stat-card slds-box slds-theme_default slds-text-align_center slds-p-around_medium">
								<div class="slds-media slds-media_center">
									<div class="slds-media__figure">
										<lightning-icon icon-name="utility:success" size="small" alternative-text="Completed"></lightning-icon>
									</div>
									<div class="slds-media__body">
										<p class="slds-text-heading_large" style="color: var(--slds-g-color-success-base-60, #2e844a)">{completedCount}</p>
										<p class="slds-text-body_small slds-text-color_weak">Completed</p>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Invitations Table -->
					<template lwc:if={hasInvitations}>
						<lightning-datatable key-field="id" data={invitations} columns={columns} hide-checkbox-column onrowaction={handleRowAction}></lightning-datatable>
					</template>

					<!-- Enhanced Empty State -->
					<template lwc:else>
						<div class="slds-box slds-theme_default slds-text-align_center slds-p-around_xx-large">
							<lightning-icon icon-name="utility:email" size="large" class="slds-m-bottom_medium empty-state-icon"></lightning-icon>
							<h3 class="slds-text-heading_medium slds-m-bottom_small">Generate Unique Survey Links</h3>
							<p class="slds-text-body_regular slds-text-color_weak slds-m-bottom_medium">
								Create unique, token-based invitation links to share your survey with participants. Each link can only be used once to ensure data integrity.
							</p>
							<lightning-button variant="brand" label="Generate Links" icon-name="utility:add" onclick={handleOpenGenerateModal} class="action-button"></lightning-button>
						</div>
					</template>
				</div>
			</template>

			<!-- Select Survey Prompt -->
			<template lwc:if={showSelectSurveyPrompt}>
				<div class="slds-box slds-theme_default slds-text-align_center slds-p-around_xx-large slds-m-around_medium">
					<lightning-icon icon-name="standard:survey" size="large" class="slds-m-bottom_medium empty-state-icon"></lightning-icon>
					<h3 class="slds-text-heading_medium slds-m-bottom_small">Select a Survey</h3>
					<p class="slds-text-body_regular slds-text-color_weak slds-m-bottom_medium">
						Choose a survey from the picker above to view existing invitation links or generate new ones for your participants.
					</p>
				</div>
			</template>
		</lightning-card>
	</div>

	<!-- Generate Links Modal -->
	<template lwc:if={showGenerateModal}>
		<section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open" aria-modal="true">
			<div class="slds-modal__container">
				<header class="slds-modal__header">
					<lightning-button-icon
						icon-name="utility:close"
						alternative-text="Close"
						onclick={handleCloseGenerateModal}
						class="slds-modal__close"
						variant="bare-inverse"></lightning-button-icon>
					<h2 class="slds-text-heading_medium">Generate Survey Links</h2>
				</header>
				<div class="slds-modal__content slds-p-around_medium">
					<!-- Survey Selector in Modal (when no survey selected) -->
					<template lwc:if={showSurveySelector}>
						<div class="slds-m-bottom_medium">
							<lightning-record-picker
								label="Select Survey"
								placeholder="Search for a survey..."
								object-api-name="Survey__c"
								value={selectedSurveyId}
								onchange={handleSurveyChange}
								required></lightning-record-picker>
							<template lwc:if={showSurveyRequiredMessage}>
								<div class="slds-text-body_small slds-text-color_error slds-m-top_x-small slds-grid slds-grid_vertical-align-center" role="alert" aria-live="polite">
									<lightning-icon icon-name="utility:warning" size="x-small" class="slds-m-right_xx-small"></lightning-icon>
									<span>Please select a survey to continue</span>
								</div>
							</template>
						</div>
					</template>

					<lightning-input
						type="number"
						label="Number of Links to Generate"
						value={linkCount}
						onchange={handleLinkCountChange}
						min="1"
						max="200"
						required
						message-when-range-underflow="Must generate at least 1 link"
						message-when-range-overflow="Cannot generate more than 200 links at once"
						field-level-help="Enter how many unique survey links to create. Each link is single-use and tied to one respondent for data integrity."></lightning-input>
					<p class="slds-text-body_small slds-text-color_weak slds-m-top_small">Each link is unique and can only be used once to complete the survey.</p>
				</div>
				<footer class="slds-modal__footer">
					<lightning-button label="Cancel" onclick={handleCloseGenerateModal}></lightning-button>
					<lightning-button variant="brand" label={generateButtonLabel} onclick={handleGenerateLinks} disabled={isGenerateDisabled}></lightning-button>
				</footer>
			</div>
		</section>
		<div class="slds-backdrop slds-backdrop_open"></div>
	</template>

	<!-- Generated Links Modal -->
	<template lwc:if={showLinksModal}>
		<section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_large" aria-modal="true">
			<div class="slds-modal__container">
				<header class="slds-modal__header">
					<lightning-button-icon
						icon-name="utility:close"
						alternative-text="Close"
						onclick={handleCloseLinksModal}
						class="slds-modal__close"
						variant="bare-inverse"></lightning-button-icon>
					<h2 class="slds-text-heading_medium">Generated Survey Links</h2>
				</header>
				<div class="slds-modal__content slds-p-around_medium">
					<p class="slds-m-bottom_medium">{generatedCount} links generated successfully. Copy the links below to share with participants.</p>
					<div class="slds-box slds-theme_shade" style="max-height: 400px; overflow-y: auto">
						<template for:each={generatedLinks} for:item="link">
							<div key={link.token} class="generated-link-item slds-grid slds-grid_vertical-align-center slds-p-around_small slds-border_bottom">
								<div class="slds-col slds-grow">
									<div class="slds-grid slds-grid_vertical">
										<p class="slds-text-body_regular slds-truncate slds-m-bottom_xx-small" title={link.surveyUrl}>
											<lightning-icon icon-name="utility:link" size="xx-small" class="slds-m-right_xx-small"></lightning-icon>
											{link.surveyUrl}
										</p>
										<p class="slds-text-body_small slds-text-color_weak">Token: {link.token}</p>
									</div>
								</div>
								<div class="slds-col slds-no-flex">
									<lightning-button-icon
										icon-name="utility:copy"
										alternative-text="Copy link"
										title="Copy link"
										data-url={link.surveyUrl}
										onclick={handleCopyLink}
										variant="border-filled"></lightning-button-icon>
								</div>
							</div>
						</template>
					</div>
				</div>
				<footer class="slds-modal__footer">
					<lightning-button label="Copy All Links" icon-name="utility:copy" onclick={handleCopyAllLinks}></lightning-button>
					<lightning-button variant="brand" label="Done" onclick={handleCloseLinksModal}></lightning-button>
				</footer>
			</div>
		</section>
		<div class="slds-backdrop slds-backdrop_open"></div>
	</template>
</template>
