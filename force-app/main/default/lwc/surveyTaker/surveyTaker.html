<template>
	<div class="survey-shell">
		<!-- Loading State -->
		<template if:true={isLoading}>
			<div class="slds-is-relative" style="min-height: 400px">
				<lightning-spinner alternative-text="Loading survey..." size="medium"></lightning-spinner>
			</div>
		</template>

		<!-- Error State -->
		<template if:true={error}>
			<div class="error-shell">
				<section class="card">
					<div class="error-content">
						<lightning-icon icon-name="utility:error" size="large" class="error-icon" alternative-text="Error"></lightning-icon>
						<p>{error}</p>
					</div>
				</section>
			</div>
		</template>

		<!-- Survey Submitted State -->
		<template if:true={isSubmitted}>
			<div class="submitted-shell">
				<section class="card">
					<div class="submitted-content">
						<lightning-icon icon-name="utility:success" size="large" class="submitted-icon" alternative-text="Success"></lightning-icon>
						<p>{thankYouText}</p>
					</div>
				</section>
			</div>
		</template>

		<!-- Survey Form -->
		<template if:false={isLoading}>
			<template if:false={error}>
				<template if:false={isSubmitted}>
					<header class="header" role="banner">
						<div class="brand">
							<div class="brandIcon" aria-hidden="true">ðŸ“Š</div>
							<span>{headerTitle}</span>
						</div>
						<template if:true={isPreviewMode}>
							<div class="slds-badge slds-badge_inverse slds-m-left_small" role="status" aria-live="polite">
								<lightning-icon icon-name="utility:preview" size="xx-small" class="slds-m-right_xx-small"></lightning-icon>
								Preview Mode
							</div>
						</template>
						<template if:true={hasQuestions}>
							<div class="pill" role="status" aria-live="polite" aria-label={progressAriaLabel}>
								Question {currentQuestionNumber} of {totalQuestions}
							</div>
						</template>
					</header>

					<section class="intro" role="contentinfo">
						<div class="introInner">
							<div>
								<h1 id="survey-title">{introHeading}</h1>
								<p class="subhead" id="survey-description">{introSubheading}</p>
							</div>
						</div>
					</section>

					<template if:true={hasQuestions}>
						<div class="progressWrap" role="progressbar" aria-valuenow={progressPercentage} aria-valuemin="0" aria-valuemax="100" aria-label={progressAriaLabel}>
							<div class="progressTrack">
								<div class="progressFill" style={progressBarStyle}></div>
							</div>
						</div>
					</template>

					<section class="card" role="main" aria-labelledby="survey-title" aria-describedby="survey-description">
						<template if:true={showAnonymousSelection}>
							<div role="radiogroup" aria-labelledby="anonymous-heading" aria-describedby="anonymous-help">
								<div id="anonymous-heading" class="questionTitle">Choose how to submit</div>
								<div id="anonymous-help" class="questionHelp">Select whether to include your name with this response.</div>
								<div class="answer-container">
									<lightning-radio-group
										name="anonymousChoice"
										options={anonymousOptions}
										value={anonymousValue}
										type="radio"
										onchange={handleAnonymousChange}
										class="radio-vertical">
									</lightning-radio-group>
								</div>
							</div>
						</template>

						<template if:false={showAnonymousSelection}>
							<template if:true={currentQuestion}>
								<!-- Screen reader announcement for current question -->
								<div class="slds-assistive-text" role="status" aria-live="polite" aria-atomic="true">
									Question {currentQuestionNumber} of {totalQuestions}: {currentQuestion.question}
								</div>
								
								<div class="questionTitle" id="question-title" role="heading" aria-level="2">
									{currentQuestionNumber}. {currentQuestion.question}
									<template if:true={currentQuestion.required}>
										<abbr class="slds-required" title="required" aria-label="required">*</abbr>
									</template>
								</div>
								<div class="questionHelp" id="question-help">{questionHelpText}</div>

								<div class="answer-container">
									<!-- Free Text -->
									<template if:true={isFreeText}>
										<lightning-textarea
											name={currentQuestion.id}
											value={currentResponse}
											rows={currentQuestion.rowsForTextArea}
											onchange={handleCurrentResponseChange}
											class="text-input">
										</lightning-textarea>
									</template>

									<!-- Single Select -->
									<template lwc:if={isSingleSelect}>
										<template lwc:if={isHorizontalLayout}>
											<!-- Horizontal Scale Layout with Radio Buttons -->
											<div class="scale-container slds-m-top_medium">
												<template lwc:if={hasScaleEndLabels}>
													<span class="scale-end-label scale-label-start">{scaleStartLabel}</span>
												</template>
												<div class="scale-radio-wrapper" role="radiogroup" aria-labelledby="question-title" aria-describedby="question-help">
													<template for:each={scaleChoices} for:item="choice">
														<div key={choice.value} class="scale-radio-item">
															<input
																type="radio"
																id={choice.radioId}
																name={currentQuestion.id}
																value={choice.value}
																checked={choice.checked}
																onchange={handleRadioChange}
																class="scale-radio-input" />
															<label for={choice.radioId} class="scale-radio-label"> {choice.buttonText} </label>
														</div>
													</template>
												</div>
												<template lwc:if={hasScaleEndLabels}>
													<span class="scale-end-label scale-label-end">{scaleEndLabel}</span>
												</template>
											</div>
										</template>
										<template lwc:else>
											<!-- Vertical Radio Layout -->
											<div class="radio-vertical-container">
												<template for:each={currentQuestionChoices} for:item="choice">
													<div key={choice.value} class="radio-vertical-item">
														<input type="radio" id={choice.safeId} name={currentQuestion.id} value={choice.value} checked={choice.checked} onchange={handleRadioChange} />
														<label for={choice.safeId} class="radio-vertical-label">{choice.label}</label>
													</div>
												</template>
											</div>
										</template>
									</template>

									<!-- Multi-Select -->
									<template if:true={isMultiSelect}>
										<div class="checkbox-container">
											<template for:each={currentQuestion.choices} for:item="choice">
												<div key={choice.value} class="slds-checkbox pill-checkbox">
													<input type="checkbox" id={choice.value} value={choice.value} checked={choice.checked} onchange={handleCheckboxChange} />
													<label class="slds-checkbox__label" for={choice.value}>
														<span class="slds-checkbox_faux"></span>
														<span class="slds-form-element__label">{choice.label}</span>
													</label>
												</div>
											</template>
										</div>
									</template>
								</div>
							</template>
						</template>
					</section>

					<div class="actions" role="navigation" aria-label="Survey navigation">
						<button 
							class="btn btnNeutral" 
							onclick={handlePrevious} 
							disabled={isFirstQuestion}
							aria-label="Go to previous question"
							aria-disabled={isFirstQuestion}>
							Back
						</button>
						<template if:false={showAnonymousSelection}>
							<template if:false={isLastQuestion}>
								<button 
									class="btn btnPrimary" 
									onclick={handleNext}
									aria-label="Go to next question">
									Next
								</button>
							</template>
							<template if:true={isLastQuestion}>
								<template if:true={canChooseAnonymous}>
									<button 
										class="btn btnPrimary" 
										onclick={handleNext}
										aria-label="Continue to submission options">
										Continue
									</button>
								</template>
								<template if:false={canChooseAnonymous}>
									<button 
										class="btn btnPrimary" 
										onclick={handleSubmit} 
										disabled={isSubmitting}
										aria-label="Submit survey responses"
										aria-disabled={isSubmitting}>
										Submit
									</button>
								</template>
							</template>
						</template>
						<template if:true={showAnonymousSelection}>
							<button 
								class="btn btnPrimary" 
								onclick={handleSubmit} 
								disabled={isSubmitting}
								aria-label="Submit survey responses"
								aria-disabled={isSubmitting}>
								Submit
							</button>
						</template>
					</div>

					<footer class="footer">
						<div class="footerDesign" aria-hidden="true">
							<div class="blob blobSlate"></div>
							<div class="blob blobOrange"></div>
							<div class="blob blobAmber"></div>

							<div class="footerWave">
								<svg viewBox="0 0 1440 120" preserveAspectRatio="none" aria-hidden="true">
									<path class="waveFill" d="M0,64 C180,96 360,20 540,44 C720,68 900,124 1080,92 C1260,60 1350,44 1440,60 L1440,120 L0,120 Z"></path>
									<path class="waveStroke" fill="none" d="M0,64 C180,96 360,20 540,44 C720,68 900,124 1080,92 C1260,60 1350,44 1440,60"></path>
								</svg>
							</div>
						</div>
					</footer>
				</template>
			</template>
		</template>
	</div>
</template>
