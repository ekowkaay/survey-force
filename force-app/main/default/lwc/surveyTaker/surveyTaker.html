<template>
	<lightning-card>
		<!-- Loading State -->
		<template if:true={isLoading}>
			<div class="slds-is-relative" style="min-height: 200px">
				<lightning-spinner alternative-text="Loading survey..." size="medium"></lightning-spinner>
			</div>
		</template>

		<!-- Error State -->
		<template if:true={error}>
			<div class="slds-box slds-theme_error slds-m-around_medium">
				<p class="slds-text-heading_small">{error}</p>
			</div>
		</template>

		<!-- Survey Submitted State -->
		<template if:true={isSubmitted}>
			<div class="slds-m-around_medium">
				<div class="slds-text-align_center slds-m-vertical_large">
					<lightning-icon icon-name="utility:success" size="large" class="slds-m-bottom_medium"></lightning-icon>
					<h2 class="slds-text-heading_large slds-m-bottom_medium">Thank You!</h2>
					<div class="slds-text-body_regular">
						<lightning-formatted-rich-text value={thankYouText}></lightning-formatted-rich-text>
					</div>
				</div>
			</div>
		</template>

		<!-- Survey Form -->
		<template if:false={isLoading}>
			<template if:false={error}>
				<template if:false={isSubmitted}>
					<!-- Dynamic Invitation Header (shown when accessing via invitation link) -->
					<template if:true={invitationHeader}>
						<div class="slds-box slds-theme_info slds-m-around_medium">
							<p class="slds-text-body_regular">{invitationHeader}</p>
						</div>
					</template>

					<!-- Survey Header -->
					<template if:true={showSurveyName}>
						<div class="slds-box slds-theme_shade slds-m-around_medium">
							<template if:true={surveyHeader}>
								<h1 class="slds-text-heading_large">{surveyHeader}</h1>
							</template>
							<template if:true={surveyName}>
								<h2 class="slds-text-heading_medium">{surveyName}</h2>
							</template>
						</div>
					</template>

					<!-- Questions -->
					<div class="slds-m-around_medium">
						<template for:each={visibleQuestions} for:item="question">
							<c-survey-question key={question.id} question={question} onresponsechange={handleResponseChange}></c-survey-question>
						</template>
					</div>

					<!-- Anonymous Selection -->
					<template if:true={canChooseAnonymous}>
						<div class="slds-box slds-theme_default slds-m-around_medium">
							<div class="slds-form-element">
								<label class="slds-form-element__label">Answer as:</label>
								<div class="slds-form-element__control">
									<lightning-radio-group
										name="anonymousChoice"
										options={anonymousOptions}
										value={anonymousValue}
										type="radio"
										onchange={handleAnonymousChange}></lightning-radio-group>
								</div>
							</div>
						</div>
					</template>

					<!-- Submit Button -->
					<div class="slds-box slds-theme_default slds-m-around_medium">
						<div class="slds-text-align_center">
							<lightning-button variant="brand" label="Submit Survey" onclick={handleSubmit} disabled={isSubmitting} class="slds-m-top_small"></lightning-button>
						</div>
					</div>
				</template>
			</template>
		</template>
	</lightning-card>
</template>
