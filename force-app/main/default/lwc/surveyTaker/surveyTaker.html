<template>
	<div class="survey-shell">
		<!-- Loading State -->
		<template if:true={isLoading}>
			<div class="slds-is-relative" style="min-height: 400px">
				<lightning-spinner alternative-text="Loading survey..." size="medium"></lightning-spinner>
			</div>
		</template>

		<!-- Error State -->
		<template if:true={error}>
			<div class="slds-box slds-theme_error slds-m-around_medium">
				<p class="slds-text-heading_small">{error}</p>
			</div>
		</template>

		<!-- Survey Submitted State -->
		<template if:true={isSubmitted}>
			<div class="submitted-shell">
				<section class="card">
					<div class="questionTitle">Thank you!</div>
					<div class="questionHelp">Your response has been recorded.</div>
					<div class="submitted-content">
						<lightning-icon icon-name="utility:success" size="large" class="submitted-icon" alternative-text="Success"></lightning-icon>
						<lightning-formatted-rich-text value={thankYouText}></lightning-formatted-rich-text>
					</div>
				</section>
			</div>
		</template>

		<!-- Survey Form -->
		<template if:false={isLoading}>
			<template if:false={error}>
				<template if:false={isSubmitted}>
					<header class="header">
						<div class="brand">
							<div class="brandIcon">ðŸ“Š</div>
							<span>{headerTitle}</span>
						</div>
						<template if:true={hasQuestions}>
							<div class="pill">Question {currentQuestionNumber} of {totalQuestions}</div>
						</template>
					</header>

					<section class="intro">
						<div class="introInner">
							<div>
								<h1>{introHeading}</h1>
								<p class="subhead">{introSubheading}</p>
							</div>
						</div>
					</section>

					<template if:true={hasQuestions}>
						<div class="progressWrap">
							<div class="progressTrack">
								<div class="progressFill" style={progressBarStyle}></div>
							</div>
						</div>
					</template>

					<section class="card">
						<template if:true={showAnonymousSelection}>
							<div class="questionTitle">Choose how to submit</div>
							<div class="questionHelp">Select whether to include your name with this response.</div>
							<div class="answer-container">
								<lightning-radio-group
									name="anonymousChoice"
									options={anonymousOptions}
									value={anonymousValue}
									type="radio"
									onchange={handleAnonymousChange}
									class="radio-vertical">
								</lightning-radio-group>
							</div>
						</template>

						<template if:false={showAnonymousSelection}>
							<template if:true={currentQuestion}>
								<div class="questionTitle" id="question-title">{currentQuestionNumber}. {currentQuestion.question}</div>
								<div class="questionHelp" id="question-help">{questionHelpText}</div>

								<div class="answer-container">
									<!-- Free Text -->
									<template if:true={isFreeText}>
										<lightning-textarea
											name={currentQuestion.id}
											value={currentResponse}
											rows={currentQuestion.rowsForTextArea}
											onchange={handleCurrentResponseChange}
											class="text-input">
										</lightning-textarea>
									</template>

									<!-- Single Select -->
									<template lwc:if={isSingleSelect}>
										<template lwc:if={isHorizontalLayout}>
											<!-- Horizontal Scale Layout -->
											<div class="scale-container slds-m-top_medium">
												<div class="scale-label scale-label-start">Agree</div>
												<div class="scale-buttons-wrapper" role="radiogroup" aria-labelledby="question-title" aria-describedby="question-help">
													<template for:each={scaleChoices} for:item="choice">
														<div key={choice.value} class="scale-button-container">
															<button
																type="button"
																class={choice.buttonClass}
																data-value={choice.value}
																onclick={handleScaleSelection}
																role="radio"
																aria-checked={choice.checked}
																aria-label={choice.label}>
																{choice.buttonText}
															</button>
															<template lwc:if={choice.showLabel}>
																<span class="scale-label">{choice.label}</span>
															</template>
														</div>
													</template>
												</div>
												<div class="scale-label scale-label-end">Strongly Agree</div>
											</div>
										</template>
										<template lwc:else>
											<!-- Vertical Radio Layout -->
											<div class="agreement-header">Please indicate your level of agreement with the statement above</div>
											<div class="scale-container">
												<div class="scale-label scale-label-start">Disagree</div>
												<div class="radio-button-group">
													<template for:each={currentQuestionChoices} for:item="choice">
														<div key={choice.value} class="radio-button-item">
															<input type="radio" id={choice.safeId} name={currentQuestion.id} value={choice.value} checked={choice.checked} onchange={handleRadioChange} />
															<label for={choice.safeId} class="radio-button-label">{choice.label}</label>
														</div>
													</template>
												</div>
												<div class="scale-label scale-label-end">Strongly Agree</div>
											</div>
										</template>
									</template>

									<!-- Multi-Select -->
									<template if:true={isMultiSelect}>
										<div class="checkbox-container">
											<template for:each={currentQuestion.choices} for:item="choice">
												<div key={choice.value} class="slds-checkbox pill-checkbox">
													<input type="checkbox" id={choice.value} value={choice.value} checked={choice.checked} onchange={handleCheckboxChange} />
													<label class="slds-checkbox__label" for={choice.value}>
														<span class="slds-checkbox_faux"></span>
														<span class="slds-form-element__label">{choice.label}</span>
													</label>
												</div>
											</template>
										</div>
									</template>
								</div>
							</template>
						</template>
					</section>

					<div class="actions">
						<button class="btn btnNeutral" onclick={handlePrevious} disabled={isFirstQuestion}>Back</button>
						<template if:false={showAnonymousSelection}>
							<template if:false={isLastQuestion}>
								<button class="btn btnPrimary" onclick={handleNext}>Next</button>
							</template>
							<template if:true={isLastQuestion}>
								<template if:true={canChooseAnonymous}>
									<button class="btn btnPrimary" onclick={handleNext}>Continue</button>
								</template>
								<template if:false={canChooseAnonymous}>
									<button class="btn btnPrimary" onclick={handleSubmit} disabled={isSubmitting}>Submit</button>
								</template>
							</template>
						</template>
						<template if:true={showAnonymousSelection}>
							<button class="btn btnPrimary" onclick={handleSubmit} disabled={isSubmitting}>Submit</button>
						</template>
					</div>

					<footer class="footer">
						<div class="footerDesign" aria-hidden="true">
							<div class="blob blobSlate"></div>
							<div class="blob blobOrange"></div>
							<div class="blob blobAmber"></div>

							<div class="footerWave">
								<svg viewBox="0 0 1440 120" preserveAspectRatio="none" aria-hidden="true">
									<path class="waveFill" d="M0,64 C180,96 360,20 540,44 C720,68 900,124 1080,92 C1260,60 1350,44 1440,60 L1440,120 L0,120 Z"></path>
									<path class="waveStroke" fill="none" d="M0,64 C180,96 360,20 540,44 C720,68 900,124 1080,92 C1260,60 1350,44 1440,60"></path>
								</svg>
							</div>
						</div>
					</footer>
				</template>
			</template>
		</template>
	</div>
</template>
