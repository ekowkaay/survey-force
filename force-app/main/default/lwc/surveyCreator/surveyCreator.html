<template>
	<!-- Loading State -->
	<template lwc:if={isLoading}>
		<div class="slds-is-relative loading-container">
			<lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
		</div>
	</template>

	<!-- Main Content -->
	<template lwc:else>
		<div class="survey-creator-container">
			<!-- Header Section -->
			<div class="survey-header slds-p-around_medium">
				<div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
					<div class="slds-col">
						<div class="slds-media slds-media_center">
							<div class="slds-media__figure">
								<lightning-icon icon-name="standard:survey" size="large"></lightning-icon>
							</div>
							<div class="slds-media__body">
								<h1 class="slds-text-heading_large">{displaySurveyName}</h1>
								<p class="slds-text-body_small slds-text-color_weak">{surveyStatusText}</p>
							</div>
						</div>
					</div>
					<div class="slds-col">
						<lightning-button-group>
							<lightning-button label="Preview" icon-name="utility:preview" onclick={handlePreview}></lightning-button>
							<lightning-button variant="brand" label={createButtonLabel} icon-name="utility:save" onclick={handleCreateSurvey} disabled={isCreating}></lightning-button>
						</lightning-button-group>
					</div>
				</div>
			</div>

			<!-- Site Warning -->
			<template lwc:if={showSiteWarning}>
				<div class="slds-notify slds-notify_alert slds-alert_warning slds-m-horizontal_medium" role="alert">
					<lightning-icon icon-name="utility:warning" size="small" class="slds-m-right_x-small"></lightning-icon>
					<span class="slds-assistive-text">warning</span>
					<h2>{siteWarningMessage}</h2>
				</div>
			</template>

			<!-- Tabs Section -->
			<div class="slds-tabs_default">
				<lightning-tabset active-tab-value={activeTab} variant="scoped">
					<!-- Build Tab -->
					<lightning-tab label="Build" value="build" icon-name="utility:builder">
						<div class="tab-content slds-p-around_medium">
							<!-- Survey Settings Card -->
							<div class="slds-card settings-card slds-m-bottom_medium">
								<div class="slds-card__header slds-grid">
									<header class="slds-media slds-media_center slds-has-flexi-truncate">
										<div class="slds-media__figure">
											<lightning-icon icon-name="utility:settings" size="small"></lightning-icon>
										</div>
										<div class="slds-media__body">
											<h2 class="slds-card__header-title">
												<span>Survey Settings</span>
											</h2>
										</div>
									</header>
									<div class="slds-no-flex">
										<lightning-button-icon
											icon-name={settingsToggleIcon}
											alternative-text="Toggle settings"
											onclick={handleToggleSettings}
											variant="border-filled"></lightning-button-icon>
									</div>
								</div>
								<template lwc:if={showSettings}>
									<div class="slds-card__body slds-card__body_inner">
										<div class="slds-grid slds-wrap slds-gutters">
											<div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2">
												<lightning-input
													label="Survey Name"
													value={surveyName}
													onchange={handleNameChange}
													required
													disabled={isCreating}
													placeholder="Enter survey name"
													class="slds-m-bottom_small"></lightning-input>
											</div>
											<div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2">
												<lightning-input
													label="Survey Header"
													value={surveyHeader}
													onchange={handleHeaderChange}
													disabled={isCreating}
													placeholder="Enter header text"
													class="slds-m-bottom_small"></lightning-input>
											</div>
											<div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2">
												<lightning-textarea
													label="Thank You Message"
													value={thankYouText}
													onchange={handleThankYouTextChange}
													disabled={isCreating}
													placeholder="Enter thank you message"
													class="slds-m-bottom_small"></lightning-textarea>
											</div>
											<div class="slds-col slds-size_1-of-1 slds-large-size_1-of-2">
												<lightning-input
													label="Thank You Link"
													value={thankYouLink}
													onchange={handleThankYouLinkChange}
													disabled={isCreating}
													placeholder="https://example.com"
													class="slds-m-bottom_small"></lightning-input>
											</div>
											<div class="slds-col slds-size_1-of-1">
												<div class="slds-grid slds-wrap">
													<div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
														<lightning-input
															type="checkbox"
															label="Hide Survey Name"
															checked={hideSurveyName}
															onchange={handleHideSurveyNameChange}
															disabled={isCreating}></lightning-input>
													</div>
													<div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
														<lightning-input
															type="checkbox"
															label="All Responses Anonymous"
															checked={allResponsesAnonymous}
															onchange={handleAllResponsesAnonymousChange}
															disabled={isCreating}></lightning-input>
													</div>
												</div>
											</div>
										</div>
									</div>
								</template>
							</div>

							<!-- Questions Section -->
							<div class="slds-card questions-card">
								<div class="slds-card__header slds-grid">
									<header class="slds-media slds-media_center slds-has-flexi-truncate">
										<div class="slds-media__figure">
											<lightning-icon icon-name="utility:questions_and_answers" size="small"></lightning-icon>
										</div>
										<div class="slds-media__body">
											<h2 class="slds-card__header-title">
												<span>Questions ({questionCount})</span>
											</h2>
										</div>
									</header>
									<div class="slds-no-flex">
										<lightning-button label="Add Question" icon-name="utility:add" variant="brand" onclick={handleAddQuestion} disabled={isCreating}></lightning-button>
									</div>
								</div>
								<div class="slds-card__body">
									<template lwc:if={hasQuestions}>
										<ul class="slds-has-dividers_bottom-space questions-list">
											<template for:each={questionsWithIndex} for:item="question">
												<li key={question.id} class="slds-item question-item">
													<div class="slds-grid slds-grid_vertical-align-center slds-p-around_small">
														<div class="slds-col question-drag-handle slds-m-right_small">
															<lightning-icon icon-name="utility:drag_and_drop" size="x-small" alternative-text="Drag to reorder"></lightning-icon>
														</div>
														<div class="slds-col slds-grow">
															<div class="slds-grid slds-grid_vertical">
																<span class="slds-text-title_bold question-number">Q{question.orderNumber}</span>
																<span class="question-text">{question.question}</span>
																<span class="slds-badge slds-badge_lightest slds-m-top_xx-small question-type-badge">{question.questionType}</span>
															</div>
														</div>
														<div class="slds-col slds-no-flex">
															<lightning-button-menu alternative-text="Question actions" icon-size="x-small" menu-alignment="right" variant="border-filled">
																<lightning-menu-item
																	value="edit"
																	label="Edit"
																	icon-name="utility:edit"
																	data-question-index={question.index}
																	onclick={handleEditQuestion}></lightning-menu-item>
																<lightning-menu-item
																	value="duplicate"
																	label="Duplicate"
																	icon-name="utility:copy"
																	data-question-index={question.index}
																	onclick={handleDuplicateQuestion}></lightning-menu-item>
																<div class="slds-has-divider_top-space" role="separator"></div>
																<lightning-menu-item
																	value="delete"
																	label="Delete"
																	icon-name="utility:delete"
																	data-question-index={question.index}
																	onclick={handleDeleteQuestion}></lightning-menu-item>
															</lightning-button-menu>
														</div>
													</div>
												</li>
											</template>
										</ul>
									</template>
									<template lwc:else>
										<div class="slds-illustration slds-illustration_small empty-state slds-p-around_large">
											<div class="slds-text-longform">
												<h3 class="slds-text-heading_medium">No Questions Yet</h3>
												<p class="slds-text-body_regular">Click "Add Question" to start building your survey.</p>
											</div>
										</div>
									</template>
								</div>
							</div>
						</div>
					</lightning-tab>

					<!-- Share Tab -->
					<lightning-tab label="Share" value="share" icon-name="utility:share">
						<div class="tab-content slds-p-around_medium">
							<div class="slds-card">
								<div class="slds-card__header slds-grid">
									<header class="slds-media slds-media_center slds-has-flexi-truncate">
										<div class="slds-media__figure">
											<lightning-icon icon-name="utility:share" size="small"></lightning-icon>
										</div>
										<div class="slds-media__body">
											<h2 class="slds-card__header-title">Share Your Survey</h2>
										</div>
									</header>
								</div>
								<div class="slds-card__body slds-card__body_inner">
									<template lwc:if={surveyId}>
										<div class="share-options slds-grid slds-wrap slds-gutters">
											<div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-m-bottom_medium">
												<div class="share-option-card slds-box slds-theme_shade">
													<lightning-icon icon-name="utility:link" size="medium" class="slds-m-bottom_small"></lightning-icon>
													<h3 class="slds-text-heading_small">Copy Link</h3>
													<p class="slds-text-body_small slds-m-bottom_small">Share via email or social media</p>
													<lightning-input type="url" value={surveyLink} readonly class="slds-m-bottom_small"></lightning-input>
													<lightning-button label="Copy Link" icon-name="utility:copy" onclick={handleCopyLink}></lightning-button>
												</div>
											</div>
											<div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-m-bottom_medium">
												<div class="share-option-card slds-box slds-theme_shade">
													<lightning-icon icon-name="utility:email" size="medium" class="slds-m-bottom_small"></lightning-icon>
													<h3 class="slds-text-heading_small">Email Invitation</h3>
													<p class="slds-text-body_small slds-m-bottom_small">Send survey invitations via email</p>
													<lightning-button label="Compose Email" icon-name="utility:email" onclick={handleComposeEmail}></lightning-button>
												</div>
											</div>
										</div>
									</template>
									<template lwc:else>
										<div class="slds-illustration slds-illustration_small slds-p-around_large">
											<div class="slds-text-longform">
												<h3 class="slds-text-heading_medium">Save Your Survey First</h3>
												<p class="slds-text-body_regular">Create and save your survey to get a shareable link.</p>
											</div>
										</div>
									</template>
								</div>
							</div>
						</div>
					</lightning-tab>

					<!-- Results Tab -->
					<lightning-tab label="Results" value="results" icon-name="utility:chart">
						<div class="tab-content slds-p-around_medium">
							<div class="slds-card">
								<div class="slds-card__header slds-grid">
									<header class="slds-media slds-media_center slds-has-flexi-truncate">
										<div class="slds-media__figure">
											<lightning-icon icon-name="utility:chart" size="small"></lightning-icon>
										</div>
										<div class="slds-media__body">
											<h2 class="slds-card__header-title">Survey Results</h2>
										</div>
									</header>
								</div>
								<div class="slds-card__body slds-card__body_inner">
									<template lwc:if={surveyId}>
										<div class="results-summary slds-grid slds-wrap slds-gutters slds-m-bottom_medium">
											<div class="slds-col slds-size_1-of-3">
												<div class="metric-card slds-box slds-theme_shade slds-text-align_center">
													<span class="metric-value slds-text-heading_large">{totalResponses}</span>
													<span class="metric-label slds-text-body_small">Total Responses</span>
												</div>
											</div>
											<div class="slds-col slds-size_1-of-3">
												<div class="metric-card slds-box slds-theme_shade slds-text-align_center">
													<span class="metric-value slds-text-heading_large">{completionRate}</span>
													<span class="metric-label slds-text-body_small">Completion Rate</span>
												</div>
											</div>
											<div class="slds-col slds-size_1-of-3">
												<div class="metric-card slds-box slds-theme_shade slds-text-align_center">
													<span class="metric-value slds-text-heading_large">{averageTime}</span>
													<span class="metric-label slds-text-body_small">Avg. Time</span>
												</div>
											</div>
										</div>
										<lightning-button label="View Detailed Results" icon-name="utility:new_window" onclick={handleViewResults}></lightning-button>
									</template>
									<template lwc:else>
										<div class="slds-illustration slds-illustration_small slds-p-around_large">
											<div class="slds-text-longform">
												<h3 class="slds-text-heading_medium">No Results Yet</h3>
												<p class="slds-text-body_regular">Results will appear here once your survey receives responses.</p>
											</div>
										</div>
									</template>
								</div>
							</div>
						</div>
					</lightning-tab>

					<!-- Details Tab -->
					<lightning-tab label="Details" value="details" icon-name="utility:info">
						<div class="tab-content slds-p-around_medium">
							<div class="slds-card">
								<div class="slds-card__header slds-grid">
									<header class="slds-media slds-media_center slds-has-flexi-truncate">
										<div class="slds-media__figure">
											<lightning-icon icon-name="utility:info" size="small"></lightning-icon>
										</div>
										<div class="slds-media__body">
											<h2 class="slds-card__header-title">Survey Details</h2>
										</div>
									</header>
								</div>
								<div class="slds-card__body slds-card__body_inner">
									<dl class="slds-list_horizontal slds-wrap">
										<dt class="slds-item_label slds-text-color_weak slds-truncate">Survey Name:</dt>
										<dd class="slds-item_detail slds-truncate">{surveyName}</dd>
										<dt class="slds-item_label slds-text-color_weak slds-truncate">Status:</dt>
										<dd class="slds-item_detail slds-truncate">{surveyStatusText}</dd>
										<dt class="slds-item_label slds-text-color_weak slds-truncate">Questions:</dt>
										<dd class="slds-item_detail slds-truncate">{questionCount}</dd>
										<dt class="slds-item_label slds-text-color_weak slds-truncate">Anonymous:</dt>
										<dd class="slds-item_detail slds-truncate">{anonymousText}</dd>
										<dt class="slds-item_label slds-text-color_weak slds-truncate">Hide Name:</dt>
										<dd class="slds-item_detail slds-truncate">{hideNameText}</dd>
									</dl>
								</div>
							</div>

							<!-- Recent Surveys Section -->
							<template lwc:if={showRecentSurveys}>
								<div class="slds-card slds-m-top_medium">
									<div class="slds-card__header slds-grid">
										<header class="slds-media slds-media_center slds-has-flexi-truncate">
											<div class="slds-media__figure">
												<lightning-icon icon-name="utility:clock" size="small"></lightning-icon>
											</div>
											<div class="slds-media__body">
												<h2 class="slds-card__header-title">Recent Surveys</h2>
											</div>
										</header>
									</div>
									<div class="slds-card__body">
										<table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped">
											<thead>
												<tr class="slds-line-height_reset">
													<th class="slds-text-title_caps" scope="col">
														<div class="slds-truncate" title="Survey Name">Survey Name</div>
													</th>
													<th class="slds-text-title_caps" scope="col">
														<div class="slds-truncate" title="Questions">Questions</div>
													</th>
													<th class="slds-text-title_caps" scope="col">
														<div class="slds-truncate" title="Responses">Responses</div>
													</th>
													<th class="slds-text-title_caps" scope="col">
														<div class="slds-truncate" title="Actions">Actions</div>
													</th>
												</tr>
											</thead>
											<tbody>
												<template for:each={recentSurveys} for:item="survey">
													<tr key={survey.Id} class="slds-hint-parent">
														<td data-label="Survey Name">
															<div class="slds-truncate" title={survey.Name}>{survey.Name}</div>
														</td>
														<td data-label="Questions">
															<div class="slds-truncate">{survey.Questions__c}</div>
														</td>
														<td data-label="Responses">
															<div class="slds-truncate">{survey.Completed_Surveys__c}</div>
														</td>
														<td data-label="Actions">
															<lightning-button variant="base" label="View" data-survey-id={survey.Id} onclick={handleViewSurvey}></lightning-button>
														</td>
													</tr>
												</template>
											</tbody>
										</table>
									</div>
								</div>
							</template>
						</div>
					</lightning-tab>
				</lightning-tabset>
			</div>
		</div>
	</template>

	<!-- Question Modal -->
	<template lwc:if={showQuestionModal}>
		<section role="dialog" tabindex="-1" aria-modal="true" aria-labelledby="modal-heading-01" class="slds-modal slds-fade-in-open slds-modal_medium">
			<div class="slds-modal__container">
				<header class="slds-modal__header">
					<lightning-button-icon class="slds-modal__close" icon-name="utility:close" alternative-text="Close" onclick={handleCancelQuestion}></lightning-button-icon>
					<h2 id="modal-heading-01" class="slds-text-heading_medium slds-hyphenate">{questionModalTitle}</h2>
				</header>
				<div class="slds-modal__content slds-p-around_medium">
					<lightning-textarea
						label="Question"
						value={currentQuestion.question}
						onchange={handleQuestionChange}
						required
						placeholder="Enter your question"
						class="slds-m-bottom_medium"></lightning-textarea>

					<lightning-combobox
						label="Question Type"
						value={currentQuestion.questionType}
						options={questionTypeOptions}
						onchange={handleQuestionTypeChange}
						required
						class="slds-m-bottom_medium"></lightning-combobox>

					<lightning-input type="checkbox" label="Required" checked={currentQuestion.required} onchange={handleRequiredChange} class="slds-m-bottom_medium"></lightning-input>

					<template lwc:if={showChoices}>
						<lightning-textarea
							label="Choices (One per line)"
							value={currentQuestion.choicesText}
							onchange={handleChoicesChange}
							placeholder="Choice 1&#10;Choice 2&#10;Choice 3"
							class="slds-m-bottom_medium"></lightning-textarea>
					</template>
				</div>
				<footer class="slds-modal__footer">
					<lightning-button label="Cancel" variant="neutral" onclick={handleCancelQuestion}></lightning-button>
					<lightning-button label="Save Question" variant="brand" onclick={handleSaveQuestion}></lightning-button>
				</footer>
			</div>
		</section>
		<div class="slds-backdrop slds-backdrop_open"></div>
	</template>
</template>
